%% glutmate profile in the synaptic cleft
t = 0:50E-06:10E-03;
rels = [0.0002];
gc = @(t) (2.7E-03*(1-exp(-(t)/0.22E-03)) - 2.7E-03*(1-exp(-(t)/2E-03)));
plot(t,gc(t));

%%
close all;
%hold on;
%clear all;
set(0,'DefaultFigureWindowStyle','docked')
%dd = load('test_det_model_calbindin_run');
set(gca,'FontSize',20);
%plot((dd(:,1)),(dd(:,2)),'Color','blue','Marker','o','MarkerSize',7);
%plot(d(:,1),(d(:,3)*1E09 ),'Color','red','LineWidth',2); hold on;
%plot(d(:,1),(d(:,6) *1E07 ),'Color','blue');
[ax,h1,h2] = plotyy(d(:,1),d(:,3)*1E09,d(:,1),d(:,4)*1E06);
axis(ax(1),[0,300,0,800]);
axis(ax(2),[0,300,0,500]);

%plot(log10(d(:,3)),d(:,7),'Color','blue');
box off;
grid on;
%plot((dd(:,1)),(dd(:,2)),'Color','blue');
axis([0,300,0,800]);
title(sprintf('Testing P2Y receptor-mediated signaling in Astrocytes'),'Fontsize',16);
xlabel(sprintf('Time (sec)','Fontsize',18));
ylabel('[Ca_c_y_t^2^+] nM','Fontsize',18);
%ylabel('[Ca_c_y_t^2^+] \muM','Fontsize',18);
%ylabel('Open probability','Fontsize',18);
%print(gcf,'-djpeg',['-r','300'],'~/goofy/DATA/IISER_Job/data/figures/Astrocyte_P2YR_testing.jpeg');
%% Check the rate constant unit conversion for VGCC pre-synaptic Ca channel
a1 = @(V) 4.04E03 * exp(V/49.14E-03);
a2 = @(V) 6.70 * exp(V/42.08E-03);
a3 = @(V) 4.39E03 * exp(V/55.31E-03);
a4 = @(V) 17.33E03 * exp(V/26.55E-03);

b1 = @(V) 2.88 * exp(-V/49.14E-03);
b2 = @(V) 6.30E03 * exp(-V/42.08E-03);
b3 = @(V) 8.16E03 * exp(-V/55.31E-03);
b4 = @(V) 1.84E03 * exp(-V/26.55E-03);

V = -80E-03:1E-03:80E-03;
plot(V,b1(V));
%%
% Boltzmann f unction for steady state activation curve   
boltz = @(V)1 ./ (1+exp( (-3.9E-03 - V)/7.1E-03));
% I–V relationship with a modified Goldman – Hodgkin –Katz equation
GHK = @(V)(-3.003E-09 .* V .*( (0.3933-exp(-V /80.36E-03)) ./(1-exp(V/80.36E-03))) .*boltz(V));
volts = -80.03E-03:10E-03:80E-03;
plot(volts,GHK(volts) ./ volts);

%%
nis_colnames = char(nis_colnames{1});
colid=4;
% subplot(1,3,1,'Align');
plot(nis_ca(:,1),nis_ca(:,2));
xlabel(nis_colnames(1,:),'Fontsize',14);
ylabel(colnames(1,1),'Fontsize',14);
hold on;
subplot(1,3,2);
plot(nis_ca(:,1),nis_ca(:,3));
xlabel(nis_colnames(1,:),'Fontsize',14);
ylabel(colnames(1,2),'Fontsize',14);
subplot(1,3,3);
plot(nis_ca(:,1),nis_ca(:,4));
xlabel(nis_colnames(1,:),'Fontsize',14);
ylabel(colnames(1,3),'Fontsize',14);
set(gca,'FontSize',12);
% Fitting ---------
%t = nis_ca(:,1);
t = 0 : 1E-06 : 0.01;
a = 1700; % starting value 4
b = 3; % how long the initial value 2.51
c = 300E-06; % decay time 200E-06
d = 50; % final value 0
delay = 0.0022; % delay 0.0022
y = d + ( (a - d) ./ (1 + (abs(t-delay)/c).^b) );
%plot(t,round(y),'color','black','Linewidth',2);
%%
%close all;
% Load Nishant's data on MCell sim
nis_glu = load('data/data_Nishant/glu');
nis_ampar = load('data/data_Nishant/ampa');
% Load gillespie_stochastic sim data on indivdual AMPARs (130)
%ind_ampar = load('gillespie_ampar/avg_130_open_ampar_individual');
% Load gillespie_stochastic sim data on ensemble AMPARs (130)
%ens_ampar = load('gillespie_ampar/avg_130_open_ampar_ensemble');
% Load gillespie_stochastic sim data on ensemble Glutamate (300)
%ens_glu = load('gillespie_ampar/avg_300_glutamate_ensemble');
%figure;
hold off;
plot(nis_glu(:,1)+0.2,nis_glu(:,4),'color','red','Linewidth',1);
plot(nis_ampar(:,1)+0.2,nis_ampar(:,8),'color',[ 0,1,1],'Linewidth',1);
%plot(ens_glu(:,1),ens_glu(:,2),'color','black','Linewidth',2);
%plot(ind_ampar(:,1),ind_ampar(:,2),'color',[0.5,0.5,0.5],'Linewidth',2);
%plot(ens_ampar(:,1),ens_ampar(:,2),'color','blue','Linewidth',1);
axis([0.18, 0.3, 0, 300]);
% Fitting ---------
t = 0:(1E-06):0.1;
a = 300; % starting value
b = 2; % how long the initial value
c = 185E-06; % decay time
d = 0; % final value
y = d + ( (a - d) ./ (1 + ((t-2.0E-05)/c).^b) );
plot(t,y,'color','black','Linewidth',2);
%%
close all
incr = 100000;
i_init = 0;
for i = 1:17
    plot(dd(((i-1)*incr+1):(i)*incr,1),dd(((i-1)*incr+1):(i)*incr,4));
    hold on;
    pause;
end
%% plotting hh_pre + vgcc + buffers
clear all
close all;
set(0,'DefaultFigureWindowStyle','docked')
dd=load('main_current.out');
plot(dd(:,1),dd(:,5),'color','black','LineWidth',2);
hold on;
plot(dd(:,1),dd(:,7)*1E-03,'color','red','LineWidth',2);
%plot(dd(:,1),ones(size(dd,1),1)*-70);
%hold on; plot(dd(:,1),dd(:,4),'color','blue','LineWidth',2);

%%
% checking the pre-synaptic HH
% Na channel
close all;
v = (-140:10:70);
alpha_m = - 0.1 * (v  + 45) ./ (exp(-(v + 45) / 10) - 1);
beta_m = 4 * exp((- v + 70) / 18);
alpha_h = 0.07 * exp(-(v + 70)/ 20);
beta_h = 1 ./ (exp(-(v + 40) / 10) + 1);
alpha_n = -0.01 * (v + 60.33) ./ (exp(-(v +  60.33) / 10) - 1);
beta_n = 0.125 * exp(-(v + 70) / 80);
%plot(v,alpha_n,'color','red');
plot(v,alpha_h,'color','green');
%%
V = (-140:10:70) * 1E-03;
Alpha_m = - 0.1E03 * (V  + 45E-03) ./ (exp(-(V + 45E-03) / 10E-03) - 1);
Beta_m = 4 * exp((- V + 70E-03) / 18E-03);
Alpha_h = 0.07 * exp(-(V + 70E-03)/ 20E-03);
Beta_h = 1 ./ (exp(-(V + 40E-03) / 10E-03) + 1);
Alpha_n = -0.01E03 * (V + 60.33E-03) ./ (exp(-(V +  60.33E-03) / 10E-03) - 1);
Beta_n = 0.125 * exp(-(V + 70E-03) / 80E-03);
%plot(V,Alpha_n,'color','red');
plot(V,Alpha_h,'color','green');
%%
xlabel('Time (sec)','FontSize',20);
%ylabel('Basal release rate (1/ms) ','FontSize',20);
legend('Probability of release','Current injec','Membrane voltage (0.08 V - 1/5)','Number of Calcium ions #','Location','NorthEast');
set(gca,'FontSize',14);
%text(0.15,1.7E-03,strcat('Pr =  ',num2str(sum(test(:,2:5)),4)),'FontSize',12);
%text(0.15,1.1E-03,'V = 0.1E-06');
%print(gcf,'-djpeg',['-r','300'],'Nishant_MCELL_sim_presynaptic_Calcium.jpeg');
%% load ca_sensor_gillespie_class_vector_test- all states
clear all;
close all;
%fname = '/mnt/storage/goofy/DATA/SCRIPTS/CPP/Astron/ca_sensor_gillespie_class_vector_test_runs/ca_sensor_gillespie_class_vector_test_run_4001';
%fname = '/mnt/storage/goofy/DATA/SCRIPTS/CPP/Astron/ca_sensor_gillespie_class_vector_test_run';
fname = 'main_current_run';
dd = load(fname);
close all;
fh=stackplot(dd,size(dd));
%print(fh,'-djpeg',['-r','300'],'ca_sensor1_conCaIn5.jpeg');
%%
%fname_prefix = '/mnt/storage/goofy/DATA/SCRIPTS/CPP/Astron/ca_sensor_gillespie_class_vector_test_runs/ca_sensor_gillespie_class_vector_test_run';
fname_prefix = '/mnt/storage/goofy/DATA/SCRIPTS/CPP/Astron/main_current_runs/main_current_run';
test=plot_avg_release_rate(fname_prefix,10000,1E-04);
%load('/mnt/storage/goofy/DATA/SCRIPTS/CPP/Astron/ca_sensor_gillespie_class_vector_test_runs/ca_sensor_10000runs_matlab_vars')
%%
close all
plot(test(2:end,1),diff(test(:,11)),'LineWidth',2,'Color',[0.5, 0.5 0.5])
hold on;
plot(test(:,1),test(:,2)/70,'LineWidth',2,'Color','red')
plot(test(:,1),(test(:,3)+0.08)/5,'LineWidth',2,'Color','magenta')
plot(test(:,1),test(:,6)/100,'LineWidth',1,'Color','red')
%% load Nishant Calcium channel data
set(0,'DefaultFigureWindowStyle','docked')
%clear all;
close all;
%nis_ca = dlmread('data_Nishant/ca.dat','',1,0);
nis_ca = csvread('/mnt/storage/goofy/DATA/IISER_Job/data_others/data_Nishant/noER_Calcium_Profile.csv',1,0); % row offset = 1, col offset = 0
%hold on;
plot(nis_ca(:,1),nis_ca(:,5));
%nis_file = 'data_Nishant/ca.dat';
%nis_fid = fopen(nis_file);
%nis_colnames = textscan(nis_fid,'%s',4);
%colnames = {'Ca con. at AZ (micro M)','No. of Ca ions at AZ',' No. of Ca ions at presynaptic terminal'}; 
%fclose(nis_fid);
%%
clear all;
dd = load('test_stoch_euler_run.txt'); 
%close all;
%plot(dd(:,9)*1E12,'blue','LineWidth',2); hold on;
%plot(dd(:,2)*1E3,'black');
%subplot(2,1,1);
plot(dd(:,1),dd(:,5),'red');
%hold on;
%plot(dd(:,1),(dd(:,6))+0.08,'blue');
%subplot(2,1,2);
%plot(dd(:,1),dd(:,2),'blue');
%volts = unique(dd(:,2));
%for i = 1 : 11
%Itail(i) = mean(dd((7000:7900)+(20000*(i-1)),9));
%end;
%%
close all;
clearvars -except dd
hold off;
rowstep = round(2/dd(2,1)-dd(1,1));
start_index = 3;
stop_index = 3;
cacon = unique(dd(:,2));
%colorbar('YTickLabel',cacon);legend(num2str(cacon(start_index:stop_index)),'Location','Best');
colormap = hsv(stop_index-start_index+1);
index = 0;
for i = start_index : stop_index
   index = index+1;
   row1 = ((i-1)*rowstep) +1 ;
   row2 = i * rowstep;
   plot(dd(row1:row2,1),dd(row1:row2,3),'Color','blue','Linewidth',3); 
   hold on;
   plot(dd(row1:row2,1),dd(row1:row2,4),'Color','red','Linewidth',3); 
   plot(dd(row1:row2,1),dd(row1:row2,5),'Color','green','Linewidth',3); 
   plot(dd(row1:row2,1),dd(row1:row2,6),'Color','black','Linewidth',3);
   %plot(dd(row1:row2,1),(dd(row1:row2,3)),'Color',colormap(index,:),'Linewidth',3); 
   %plot(dd(row1:row2,1),dd(row1:row2,6),'Color',colormap(index,:),'Linewidth',3); 
   %plot(dd(row1:row2,1),dd(row1:row2,6),'Linewidth',3); 
   %text(0.45,max(dd(row1:row2,6)),strcat(num2str(dd(row2,2)),' M'),'FontSize',15)
   hold on;
end
hold off;
%legend(num2str(cacon(start_index:stop_index)),'Location','Best');
%legend('Spon','Syn','Asyn','Total','Location','East');
%axis([0.1,0.5,1E-03,1E-04]);    
%set(gca,'FontSize',22);
%xlabel('Time (sec)','Fontsize',22);
%ylabel('Cum no. of rel. vesicles','Fontsize',26);
%ylabel('Release rate (msec)','Fontsize',26);
%print(gcf,'-djpeg',['-r','100'],'Suhitha_Ca_sensor_model_cum_ves_num_400-1000nM.jpeg');
%% Averaged (binned plots)
%close all;
%hold off;
%bin_size=1E-03;
%big_rowstep = round(2/dd(2,1)-dd(1,1));
%start_index = 3;
%stop_index = 3;
%dd2=bin_mat(dd(((start_index-1)*big_rowstep) + 1: (stop_index*big_rowstep),:),bin_size);
%d=dd2;
%cacon = unique(d(:,2));
%colorbar('YTickLabel',cacon);legend(num2str(cacon(start_index:stop_index)),'Location','Best');
colormap = hsv(5);
index = 0;
for i = 1 : 4
    w456 /*   plot(log10(ip3r_end(:,2,i)),ip3r_end(:,5,i).^3,'LineWidth',2,'Color',colormap(i,:),'Marker','o','DisplayName',strcat('[IP3] = ',num2str(ip3r_end(1,4,i)*1e06),'\muM'));
   hold on;
end
hold off;
lgd=legend(gca,'show','Location','NorthEast')
%lgd=legend(num2str(ip3r_end(1,2,i)),'\muM','Location','NorthWest');
set(lgd,'FontSize',14);     
%legend(num2str(cacon(start_index:stop_index)),'Location','Best');

axis([-8, -5,0, 0.7]);    
set(gca,'FontSize',18);
xlabel('log10 [Ca^2^+]','Fontsize',18);
%ylabel('Cum no. of rel. vesicles','Fontsize',26);
ylabel('Open fraction','Fontsize',18);
title('Single IP3R kinetics: Ullah-Jung model','FontSize',18)
%print(gcf,'-djpeg',['-r','300'],'ip3_receptor_kinetics_ullah_jung_Calcium_vs_open_fraction.jpeg');
%% Matlab read csv file 
set(0,'DefaultFigureWindowStyle','docked');
% Load data
d = csvread('/home/anup/goofy/DATA/SCRIPTS/CPP/astron/insilico/outfiles/neuron_only_1hz_10s_30s/neuron_only_1hz1.csv',1,0); % row offset = 1, col offset = 0
%glu = dlmread('/mnt/storage/goofy/DATA/IISER_Job/data_others/data_Nishant/glu.dat',' ',1,0); % row offset = 1, col offset = 0
colnames=textscan(fopen('/home/anup/goofy/DATA/SCRIPTS/CPP/astron/insilico/outfiles/neuron_only_1hz_10s_30s/neuron_only_1hz1.csv'),'%s',1);fclose('all');colnames = char(colnames{:});colnames = strsplit(colnames,',');
% Start ploting
    
%set(0,'DefaultFigureWindowStyle','docked');
close all;
% Place axes at (0.1,0.1) with width and height of 0.8
fig = figure;
handaxes1 = axes('position', [0.155 0.15 0.8 0.8]);

%pos = get(fig,'Position');
%outer_pos = get(fig,'OuterPosition');
%set(gca,'OuterPosition',[outer_pos(1) + 0.07, outer_pos(2) + 0.07, outer_pos(3) - 0.19, outer_pos(4) - 0.05]);
pos = get(fig,'Position');
outer_pos = get(fig,'OuterPosition');
%set(fig,'OuterPosition',[outer_pos(1) + 0.07, outer_pos(2) + 0.07, outer_pos(3) - 0.19, outer_pos(4) - 0.05]);
% plotting
%------------------
hold off;
%plot(d(:,1),d(:,2),'Color',[1,0,0],'LineWidth',3); hold on;
plot(d(:,1),d(:,strcmp(colnames,'n1ca_cyt') == 1)*1E05,'Color',[0,0,0],'LineWidth',2); hold on;
%plot(d(:,1),d(:,strcmp(colnames,'n0gluves_h0l0') == 1),'Color',[1,0,0],'LineWidth',3); hold on;
%plot(d(:,1),d(:,strcmp(colnames,'n0atpves_spon') == 1),'Color',[1,0,0],'LineWidth',3); hold on;
%plot(d(:,1),d(:,strcmp(colnames,'n0gluves_syn') == 1),'Color',[0,1,0],'LineWidth',3); hold on;
%plot(d(:,1),d(:,strcmp(colnames,'n0gluves_asyn') == 1),'Color',[0,0,1],'LineWidth',3); hold on;
plot(d(:,1),d(:,strcmp(colnames,'n1gluves_spon_flag') == 1),'Color',[1,0,0],'LineWidth',1); hold on;
%plot(d(:,1),d(:,strcmp(colnames,'n0gluves_syn_flag') == 1),'Color',[0,1,0],'LineWidth',1); hold on;
plot(d(:,1),d(:,strcmp(colnames,'n1gluves_asyn_flag') == 1),'Color',[0,0,1],'LineWidth',1); hold on;
%plot([5,60,150,300,600,900,1800],[2.1E-0,0.125E-0,0,0,0,0,0],'Color',[1,0,0],'Marker','o','MarkerSize',10,'MarkerFaceColor',[1,0,0]);
%plot([5,60,150,300,600,900,1800],[0.05E-0,1E-0,1.5E-0,1.25E-0,0.75E-0,0.5E-0,0.2E-0],'Color',[0,0,1],'Marker','o','MarkerSize',10,'MarkerFaceColor',[0,0,1]);
%plot([60,70,80,90,100],[-81,-81,-81,-81,-81],'o','MarkerSize',7,'MarkerFaceColor',[0,0,0]);
%title(gca,' Postsynaptic potentials','FontSize',22);
%axis(gca,[12.11,12.112,-0.036585,0.31068])
hold off;
%%
%% Matlab read csv file 
d = csvread('/mnt/storage/goofy/DATA/SCRIPTS/CPP/astron/insilico/outfiles/neuron_a1_receptor_test.csv',1,0); % row offset = 1, col offset = 0
%%%
hold off;
%plotyy(d(:,1),d(:,11),d(:,1),d(:,11));
plot(d(:,1),d(:,6) ,'blue');
%hold on;
%plot(d(:,1),d(:,11),'red');
%plot(d(:,1),d(:,12),'black');
%% Processing for bifurcation analysis
base_fname = 'astrocyte_pmca_test';
path_fname = '/home/anup/goofy/DATA/SCRIPTS/CPP/astron/insilico/outfiles/testing/';
col_id = 3;
max_time = 50;
for i = 1 :21
    fname = strcat(base_fname,num2str(i),'.csv')
    d= csvread(strcat(path_fname,fname),1,0); % row offset = 1, col offset = 0
    dd(:,:,i) = d; 
    d_highs(i,1) = max(d(d(:,1)>max_time,col_id),[],1);
    d_lows(i,1) = min(d(d(:,1)>max_time,col_id),[],1);
    d_x(i,1) = max(d(d(:,1)>max_time,5),[],1);
    d_freqency(i,1) = 0;    
    delta = d_highs(i,1) - d_lows(i,1)
    if (delta > 0)
        [nspk,mint,miny,maxt,maxy] = count_spikes(d(d(:,1)>max_time,1),d(d(:,1)>max_time,col_id),delta/2);
        d_frequency(i,1) = 1/mean(diff(maxt(1:nspk)));
    end
end
%% check the poisson distribution
d = csvread('/mnt/storage/goofy/DATA/SCRIPTS/CPP/astron/insilico/infiles/ext_current_inj_poisson_test.isfc',1,0); % row offset = 1, col offset = 0